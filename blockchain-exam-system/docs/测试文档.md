# 区块链试卷管理系统 - 测试文档

## 测试环境

### 软件环境
- JDK 8+
- Maven 3.6+
- MySQL 8.0
- Redis
- Node.js 16+

### 测试账号

| 用户名 | 密码 | 角色 | 部门 | 节点 |
|--------|------|------|------|------|
| cs_teacher1 | 123456 | 教师 | 计算机系 | node1 (8081) |
| cs_teacher2 | 123456 | 教师 | 计算机系 | node1 (8081) |
| cs_dept_admin | 123456 | 系主任 | 计算机系 | node1 (8081) |
| se_teacher1 | 123456 | 教师 | 软件工程系 | node2 (8082) |
| se_teacher2 | 123456 | 教师 | 软件工程系 | node2 (8082) |
| se_dept_admin | 123456 | 系主任 | 软件工程系 | node2 (8082) |
| college_admin1 | 123456 | 院长 | 信息学院 | node3 (8083) |
| college_admin2 | 123456 | 院长 | 信息学院 | node3 (8083) |

---

## 一、区块链功能测试

### 1.1 获取区块链

```bash
# 获取节点1的完整区块链
curl http://localhost:8081/api/blockchain/chain

# 预期响应
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "blockIndex": 0,
      "timestamp": 1732521600000,
      "hash": "0000xxxx...",
      "previousHash": "0",
      "nonce": 12345,
      "difficulty": 4,
      "data": "{\"transactions\":[]}"
    }
  ]
}
```

### 1.2 获取最新区块

```bash
curl http://localhost:8081/api/blockchain/latest

# 预期响应
{
  "code": 200,
  "data": {
    "blockIndex": 5,
    "hash": "0000xxxx...",
    ...
  }
}
```

### 1.3 验证区块链

```bash
curl http://localhost:8081/api/blockchain/validate

# 预期响应（区块链完整）
{
  "code": 200,
  "message": "区块链验证通过",
  "data": true
}
```

### 1.4 手动挖矿

```bash
curl -X POST http://localhost:8081/api/blockchain/mine

# 预期响应
{
  "code": 200,
  "message": "挖矿成功",
  "data": {
    "blockIndex": 6,
    "hash": "0000xxxx...",
    "transactionCount": 3
  }
}
```

### 1.5 区块链统计

```bash
curl http://localhost:8081/api/blockchain/stats

# 预期响应
{
  "code": 200,
  "data": {
    "blockCount": 10,
    "transactionCount": 25,
    "difficulty": 4,
    "lastBlockTime": 1732521600000
  }
}
```

---

## 二、交易功能测试

### 2.1 创建交易

```bash
curl -X POST http://localhost:8081/api/transaction/create \
  -H "Content-Type: application/json" \
  -d '{
    "transactionType": "TEST",
    "transactionData": "{\"test\":\"data\"}"
  }'

# 预期响应
{
  "code": 200,
  "message": "交易创建成功",
  "data": {
    "transactionId": "tx_xxx",
    "status": "PENDING"
  }
}
```

### 2.2 查询待打包交易

```bash
curl http://localhost:8081/api/transaction/pending

# 预期响应
{
  "code": 200,
  "data": [
    {
      "transactionId": "tx_xxx",
      "transactionType": "TEST",
      "status": "PENDING",
      "timestamp": 1732521600000
    }
  ]
}
```

### 2.3 交易统计

```bash
curl http://localhost:8081/api/transaction/stats

# 预期响应
{
  "code": 200,
  "data": {
    "totalCount": 50,
    "pendingCount": 3,
    "minedCount": 47
  }
}
```

---

## 三、P2P网络测试

### 3.1 获取当前节点信息

```bash
curl http://localhost:8081/api/p2p/nodes/current

# 预期响应
{
  "code": 200,
  "data": {
    "nodeId": "node1",
    "nodeName": "计算机系节点",
    "host": "localhost",
    "port": 8081,
    "status": "ONLINE"
  }
}
```

### 3.2 获取所有节点

```bash
curl http://localhost:8081/api/p2p/nodes

# 预期响应
{
  "code": 200,
  "data": [
    {"nodeId": "node1", "status": "ONLINE", ...},
    {"nodeId": "node2", "status": "ONLINE", ...},
    {"nodeId": "node3", "status": "ONLINE", ...}
  ]
}
```

### 3.3 获取在线节点

```bash
curl http://localhost:8081/api/p2p/nodes/online

# 预期响应
{
  "code": 200,
  "data": [
    {"nodeId": "node1", "status": "ONLINE"},
    {"nodeId": "node2", "status": "ONLINE"},
    {"nodeId": "node3", "status": "ONLINE"}
  ]
}
```

### 3.4 心跳检测

```bash
curl http://localhost:8081/api/p2p/heartbeat

# 预期响应
{
  "code": 200,
  "message": "心跳成功",
  "data": {
    "nodeId": "node1",
    "timestamp": 1732521600000
  }
}
```

### 3.5 健康检查

```bash
curl http://localhost:8081/api/p2p/health

# 预期响应
{
  "code": 200,
  "message": "节点健康",
  "data": {
    "status": "UP",
    "blockchain": "OK",
    "database": "OK",
    "redis": "OK"
  }
}
```

### 3.6 手动同步

```bash
curl -X POST http://localhost:8081/api/blockchain/sync

# 预期响应
{
  "code": 200,
  "message": "同步成功",
  "data": {
    "syncedBlocks": 5,
    "sourceNode": "node2"
  }
}
```

---

## 四、业务功能测试

### 4.1 用户登录

```bash
# 获取RSA公钥
curl http://localhost:8081/api/auth/public-key

# 登录（密码需要RSA加密）
curl -X POST http://localhost:8081/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "cs_teacher1",
    "encryptedPassword": "<RSA加密后的密码>",
    "timestamp": 1732521600000,
    "nonce": "uuid-xxx"
  }'

# 预期响应
{
  "code": 200,
  "data": {
    "token": "eyJhbGciOiJIUzI1NiJ9...",
    "userInfo": {
      "id": 1,
      "username": "cs_teacher1",
      "realName": "张三",
      "role": "teacher",
      "department": "计算机系"
    }
  }
}
```

### 4.2 创建试卷（教师）

```bash
curl -X POST http://localhost:8081/api/exam-paper/create \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -d '{
    "encryptedData": "<AES加密的试卷数据>",
    "key": "<AES密钥>"
  }'

# 预期响应
{
  "code": 200,
  "message": "试卷创建成功",
  "data": 123
}
```

### 4.3 提交审批

```bash
curl -X POST http://localhost:8081/api/exam-paper/submit/123 \
  -H "Authorization: Bearer <token>"

# 预期响应
{
  "code": 200,
  "message": "试卷已提交审批"
}
```

### 4.4 审批通过（系主任/院长）

```bash
curl -X POST http://localhost:8081/api/approval/approve \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -d '{
    "paperId": 123,
    "comment": "审批通过",
    "password": "123456"
  }'

# 预期响应
{
  "code": 200,
  "message": "审批通过",
  "data": {
    "recordId": 456,
    "signature": "xxx...",
    "blockHash": "0000xxx..."
  }
}
```

### 4.5 验证签名

```bash
curl -X POST http://localhost:8081/api/approval/verify/456

# 预期响应
{
  "code": 200,
  "data": {
    "valid": true,
    "message": "签名验证通过"
  }
}
```

---

## 五、多节点联调测试

### 5.1 测试场景：跨节点交易广播

1. 在节点1创建交易
2. 检查节点2、节点3是否收到交易

```bash
# 节点1创建交易
curl -X POST http://localhost:8081/api/transaction/create \
  -H "Content-Type: application/json" \
  -d '{"transactionType":"TEST","transactionData":"{\"msg\":\"hello\"}"}'

# 检查节点2
curl http://localhost:8082/api/transaction/pending

# 检查节点3
curl http://localhost:8083/api/transaction/pending
```

### 5.2 测试场景：区块链同步

1. 在节点1挖矿产生新区块
2. 触发节点2、节点3同步
3. 验证三个节点区块链一致

```bash
# 节点1挖矿
curl -X POST http://localhost:8081/api/blockchain/mine

# 节点2同步
curl -X POST http://localhost:8082/api/blockchain/sync

# 节点3同步
curl -X POST http://localhost:8083/api/blockchain/sync

# 验证区块数量一致
curl http://localhost:8081/api/blockchain/stats
curl http://localhost:8082/api/blockchain/stats
curl http://localhost:8083/api/blockchain/stats
```

### 5.3 测试场景：审批流程上链

1. 教师在节点1创建试卷并提交
2. 系主任在节点1审批
3. 院长在节点3终审
4. 验证审批记录已上链

---

## 六、测试结果记录

### 测试时间
- 开始时间：____
- 结束时间：____

### 测试人员
- ____

### 测试结果

| 测试项 | 状态 | 备注 |
|--------|------|------|
| 区块链获取 | □ 通过 / □ 失败 | |
| 区块链验证 | □ 通过 / □ 失败 | |
| 手动挖矿 | □ 通过 / □ 失败 | |
| 交易创建 | □ 通过 / □ 失败 | |
| 交易广播 | □ 通过 / □ 失败 | |
| P2P心跳 | □ 通过 / □ 失败 | |
| 区块链同步 | □ 通过 / □ 失败 | |
| 用户登录 | □ 通过 / □ 失败 | |
| 试卷创建 | □ 通过 / □ 失败 | |
| 审批流程 | □ 通过 / □ 失败 | |
| 签名验证 | □ 通过 / □ 失败 | |

### 发现的问题
1. ____
2. ____
3. ____

---

**文档版本**：v1.0
**更新时间**：2025-11-26
